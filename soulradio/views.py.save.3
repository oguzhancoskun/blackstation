from django.shortcuts import render
from django.http import HttpResponse
from django.shortcuts import render_to_response
from django.templatetags.static import static
import soundcloud

from django.template import Template, Context

#db imps
import psycopg2
from models import Toplist

def home(request):

        client = soundcloud.Client(client_id='0c7ba7f850fd26aa4b6c0efc42e4838b')

	musicx=[]
	namex=[]
	
 	lst = Toplist.objects.all()
	count = len(lst)
	for l in lst:
        	play = client.get('/tracks/'+l.name)
        	
		s = client.get(play.stream_url, allow_redirects=False)	
	
		musicx.append(s.location)		
		namex.append(l)
	s=Template(u'''
	<html>
	
		<head>
			<link href='http://fonts.googleapis.com/css?family=Aldrich' rel='stylesheet' type='text/css'>		
			<link href="http://fonts.googleapis.com/css?family=Alfa+Slab+One" rel="stylesheet" type="text/css">
			{%load staticfiles%}

			<link rel='stylesheet' type='text/css' href='{% static "style.css" %}'/>

			<script type="text/javascript" src="http://code.jquery.com/jquery-1.8.2.min.js"></script>				
			
			<script>
				window.onload=function what(){
											
				 $(document).ready(function() {
                                 $('body').css('background','url({%static "tupac.jpg"%}) no-repeat center center fixed');
                                	});

                                var audio= document.getElementById('audio');
                                var listm=[];
                                var namex=[];
                                {% for m in musicx %}
                                        listm.push("{{m}}");
                                {% endfor %}

                                {% for n in namex %}
                                        namex.push("{{n}}");
                                {% endfor %}

                                var first = Math.floor(Math.random()*listm.length);

                                var ptag= document.getElementById('p1');
                                ptag.innerHTML=namex[first].toUpperCase();

                                audio.setAttribute('src',listm[first]);
                                audio.play();

                                len = listm.length;
                                audio.addEventListener('ended',function()
                                        {
                                                var rnd = Math.floor(Math.random()*listm.length);

                                                this.src=listm[rnd];
                                                ptag.innerHTML=namex[rnd].toUpperCase();

                                                audio.setAttribute('src',listm[first]);
                                audio.play();

                                len = listm.length;
                                audio.addEventListener('ended',function()
                                        {
                                                var rnd = Math.floor(Math.random()*listm.length);

                                                this.src=listm[rnd];
                                                ptag.innerHTML=namex[rnd].toUpperCase();
                                                this.play();
                                        });

					}); }
					
				  function fch(){
                                        var sound=new Audio('{% static  "change.mp3"%}');
                                        var audio=document.getElementById('audio');
                                        audio.pause();
                                        sound.play();

                                        setTimeout(function(){

                                         var listm=[];
                                                var namex=[];
                                                {% for m in musicx %}
                                                listm.push("{{m}}");
                                                {% endfor %}

                                                {% for n in namex %}
                                                namex.push("{{n}}");
                                                 {% endfor %}

                                                var first = Math.floor(Math.random()*listm.length);

                                                var ptag= document.getElementById('p1');
                                                  ptag.innerHTML=namex[first].toUpperCase();

                                                  audio.setAttribute('src',listm[first]);
                                                 audio.play();

                                                },3000);
                                       }

                                var sec=0, min=0;

                                 function time(){

                                if(sec<59) sec++;

                                else{
                                        sec=0;
                                        min++;
                                        }
                                        $('#time').html(min+":"+sec);
                                        }
                        $(document).ready(function(){
                                        $('#time').html("0:0");
                                        setInterval(time,1000);
                                });

				
			</script>
												
       	          </head>
		
		<body>	
			<div class='fullscreen'>		
				<audio id='audio'></audio>

				<div class='sticker'>
                                        <marquee behavior='scroll' scrollamount='3' direction='right' class='art' id='p1'></marquee>
                                </div>				
				<div onclick='fch()' class='change'>
                                       <p class='art'> CHANGE </p>
                                </div>

				<div class='timer'>
					<p class='art' id='time'></p>
				</div>

				<div class="count">
					
					<span style='font-size:14px;'>TOTAL MUSIC</span> 
					<center>	
						{{count}}
					</center>
					<span style='font-size:10px;'>AND MORE</span>
					
				</div>
				
				<br>

				<center>
					<div style='background:url("https://lh6.googleusercontent.com/-LrGIFj0NSaY/UPQkWIdlzNI/AAAAAAAAACI/KZaGXcLTjaY/s150-c/photo.jpg");'
						class='load'></div>
					<div style='background:url("https://lh5.googleusercontent.com/-2XvMGAmBydY/UUyCa-RZrKI/AAAAAAAAAHI/dnp3tYYY5TY/s150-c/photo.jpg");' 
						class='load'></div>
					<div style='background:url("http://www.mypunjabivirsa.com/wp-content/uploads/2010/11/Britney-Spears-150x150.jpg");'
						class='load'></div>				
				</center>
				</div>

				<div>
			<footer>

				<img style='float:left; width:100px; height:55px; margin-left:5px;'
			 src='http://www.facebookfanskaufen24.de/wp-content/uploads/2012/11/soundcloud2.png'/>				
				<img style='float:left; width:100px; height:55px; margin-left:5px;'
			 src='http://buala.net/django/img/django.png'/>
			
			</footer>
		</body>
	</html>

		''')	
	
        #client.put('/me/favorites/%d' % track.id)

	b=Context({'musicx':musicx,'namex':namex,'count':count})
	html=s.render(b)

	return HttpResponse(html)
